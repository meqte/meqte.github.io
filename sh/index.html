#!/bin/bash
############################################
#  bash <(curl -sL meqte.github.io/sh)     #
############################################

# ========== 1. 基础配置 ==========
BASE_URL="https://meqte.github.io/sh"
KJ_URL="https://raw.githubusercontent.com/kejilion/sh/main/kejilion.sh"
RTSP_DIR="/root/rtsp"            
RTSP_SHELL="$RTSP_DIR/rtsp.sh"   
LOCAL_MAIN="/root/m.sh"          
VERSION="2026.01.01"

# ========== 2. 自动化注册 m 快捷键 (秒开逻辑) ==========
init_shortcut() {
    # 检查 m.sh 是否存在或快捷键 x 是否已创建
    if [ ! -f "$LOCAL_MAIN" ] || [ ! -L "/usr/local/bin/m" ]; then
        [ ! -d "/root" ] && mkdir -p "/root"
        curl -sL "${BASE_URL}/index.html" -o "$LOCAL_MAIN"
        chmod +x "$LOCAL_MAIN"
        ln -sf "$LOCAL_MAIN" /usr/local/bin/x
        hash -r 2>/dev/null
    fi
}
# ========== 3. 颜色定义 ==========
BOX_COLOR='\033[1;36m'   
INFO_COLOR='\033[38;5;81m' 
OPT_NUM='\033[1;36m'    
WARN_COLOR='\033[1;33m' 
EXIT_COLOR='\033[1;31m' 
NC='\033[0m'            

# ========== 4. 核心功能逻辑 ==========

# 远程组件调用函数 (解决交互与闪退的核心)
call_remote() {
    local cmd="$1"
    echo -e "\n${INFO_COLOR}正在从云端加载组件: $cmd ...${NC}"
    
    # 下载临时文件以支持完整交互
    curl -sL "$KJ_URL" -o /root/kejilion.sh
    chmod +x /root/kejilion.sh
    
    # 运行组件
    /root/kejilion.sh.sh "$cmd"
    
    # 运行完后清理
    rm -f /root/kejilion.sh
    
    # 针对非菜单类功能（如查看信息、清理），强制停顿方便观察结果
    if [[ "$cmd" == "info" || "$cmd" == "update" || "$cmd" == "clean" || "$cmd" == "bbr" || "$cmd" == "test" ]]; then
        echo -e "\n${WARN_COLOR}------------------------------------------"
        echo -e " ${INFO_COLOR}任务执行完毕。按 [回车键] 返回 Mjack Tools...${NC}"
        echo -e "${WARN_COLOR}------------------------------------------${NC}"
        read -p ""
    fi
    show_menu
}

handle_rtsp() {
    if [ -f "$RTSP_SHELL" ]; then
        bash "$RTSP_SHELL"
    else
        echo -e "\n${WARN_COLOR}本地 RTSP 组件未安装，正在启动分发脚本...${NC}"
        bash <(curl -sL "${BASE_URL}/rtsp/index.html")
        [ -f "$RTSP_SHELL" ] && bash "$RTSP_SHELL"
    fi
    show_menu 
}

# ========== 5. 菜单界面 ==========
show_menu() {
    clear
    echo -e "${BOX_COLOR}╔═══════════════════════════════════════════════╗${NC}"
    echo -e "${BOX_COLOR}║    ╔═╗╔═╗╦═╗╔╦╗╔═╗  ╦╔═╗╦  ╦  ╔═╗╔═╗╔╦╗╔═╗    ║${NC}"
    echo -e "${BOX_COLOR}║    ╠═╝║ ║╠╦╝ ║ ║╣   ║╠═╣║  ║  ║╣ ║   ║ ╚═╗    ║${NC}"
    echo -e "${BOX_COLOR}║    ╩  ╚═╝╩╚═ ╩ ╚═╝  ╩╩ ╩╩═╝╩═╝╚═╝╚═╝ ╩ ╚═╝    ║${NC}"
    echo -e "${BOX_COLOR}║     ─────── M j a c k   T o o l s ───────     ║${NC}"
    echo -e "${BOX_COLOR}╚═══════════════════════════════════════════════╝${NC}"
    echo -e " 科技Mjack脚本工具箱 ${INFO_COLOR}v${VERSION}${NC} | 快捷键: ${WARN_COLOR}x${NC}"
    echo -e " ------------------------------------------"

    echo -e " ${OPT_NUM}1.${NC}   RTSP 推流管理系统 (原创)"
    echo -e " ${OPT_NUM}2.${NC}   系统信息查询"
    echo -e " ${OPT_NUM}3.${NC}   系统更新"
    echo -e " ${OPT_NUM}4.${NC}   系统清理"
    echo -e " ${OPT_NUM}5.${NC}   基础工具安装"
    echo -e " ${OPT_NUM}6.${NC}   BBR 加速管理"
    echo -e " ${OPT_NUM}7.${NC}   Docker 容器管理"
    echo -e " ${OPT_NUM}8.${NC}   WARP 网络管理"
    echo -e " ${OPT_NUM}9.${NC}   测试脚本合集"
    echo -e " ${OPT_NUM}10.${NC}  甲骨文云脚本合集"
    echo -e " ${OPT_NUM}11.${NC}  LDNMP 建站环境"
    echo -e " ${OPT_NUM}12.${NC}  应用市场 (面板大全)"
    echo -e " ${OPT_NUM}13.${NC}  后台工作区 (Screen)"
    echo -e " ${OPT_NUM}14.${NC}  系统工具 / 集群控制"
    
    echo -e " ------------------------------------------"
    echo -e " ${INFO_COLOR}88.${NC}  同步最新脚本代码"
    echo -e " ------------------------------------------"
    echo -e " ${EXIT_COLOR}0.${NC}   退出 Mjack Tools"
    echo -e " ------------------------------------------"
    
    echo -ne " 请输入你的选择: "
    read choice

    case $choice in
        1)  handle_rtsp ;;
        2)  call_remote info ;;
        3)  call_remote update ;;
        4)  call_remote clean ;;
        5)  call_remote tool ;;
        6)  call_remote bbr ;;
        7)  call_remote docker ;;
        8)  call_remote warp ;;
        9)  call_remote test ;;
        10) call_remote oracle ;;
        11) call_remote ldnmp ;;
        12) call_remote store ;;
        13) call_remote screen ;;
        14) call_remote system ;;
        88)
            echo -e "\n${INFO_COLOR}正在同步最新版本...${NC}"
            curl -sL "${BASE_URL}/index.html" -o "$LOCAL_MAIN"
            chmod +x "$LOCAL_MAIN"
            echo -e "${GREEN}同步完成！请重新运行 m${NC}"
            exit 0
            ;;
        0)  echo -e "\n再见！"; exit 0 ;;
        *)  show_menu ;;
    esac
}

# 执行入口
if [ "$EUID" -ne 0 ]; then echo -e "${EXIT_COLOR}请以 root 权限运行${NC}"; exit 1; fi
init_shortcut
show_menu
