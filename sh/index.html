#!/bin/bash

# ========== 配置区 ==========
BASE_URL="https://meqte.github.io/sh"
RTSP_DIR="/root/rtsp"
RTSP_SHELL="$RTSP_DIR/rtsp.sh"

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 菜单逻辑
show_menu() {
    clear
    echo -e "${BLUE}===========================================${NC}"
    echo -e "${GREEN}       欢迎使用 Meqte 一键工具箱           ${NC}"
    echo -e "${BLUE}===========================================${NC}"
    echo -e "  1. RTSP 推流服务器 (MediaMTX + FFmpeg)"
    echo -e "  2. 检查系统负载"
    echo -e "  3. 建设中..."
    echo -e "  q. 退出"
    echo -e "${BLUE}===========================================${NC}"
    read -p "请输入数字选择: " choice

    case $choice in
        1)
            handle_rtsp
            ;;
        2)
            uptime
            read -p "按回车键返回..."
            show_menu
            ;;
        q)
            exit 0
            ;;
        *)
            echo "无效输入，请重新选择"
            sleep 1
            show_menu
            ;;
    esac
}

# 处理RTSP逻辑：核心判断就在这里
handle_rtsp() {
    if [ -f "$RTSP_SHELL" ]; then
        echo -e "${GREEN}✅ 检测到本地已安装 RTSP 工具，正在启动...${NC}"
        # 已经存在，直接执行本地脚本
        bash "$RTSP_SHELL"
    else
        echo -e "${YELLOW}📡 本地未检测到组件，正在从云端获取安装程序...${NC}"
        # 不存在，调用安装脚本
        # 注意这里的路径：sh/rtsp/index.html
        bash <(curl -sL ${BASE_URL}/rtsp/index.html)
        
        # 安装完成后，再次确认文件是否存在并运行
        if [ -f "$RTSP_SHELL" ]; then
            bash "$RTSP_SHELL"
        else
            echo "❌ 安装似乎失败了，请检查网络。"
            read -p "按回车键返回..."
        fi
    fi
}

# 检查Root权限
if [ "$EUID" -ne 0 ]; then
  echo "❌ 请以 root 用户执行"
  exit 1
fi

show_menu