#!/bin/bash

# ========== 1. 基础配置 ==========
BASE_URL="https://meqte.github.io/sh"
RTSP_DIR="/root/rtsp"            # 修改：指向 rtsp 专用目录
RTSP_SHELL="$RTSP_DIR/rtsp.sh"   # 修改：确保这里和子脚本下载位置完全对齐
LOCAL_MAIN="/root/mm.sh"
VERSION="2026.01.14"

# ========== 2. 自动化注册 mm 快捷键 ==========
init_shortcut() {
    # 只有当快捷键不存在或者文件不存在时才下载，避免重复下载主脚本
    if [ ! -f "$LOCAL_MAIN" ] || [ ! -L "/usr/local/bin/mm" ]; then
        [ ! -d "/root" ] && mkdir -p "/root"
        curl -sL "${BASE_URL}/index.html" -o "$LOCAL_MAIN"
        chmod +x "$LOCAL_MAIN"
        ln -sf "$LOCAL_MAIN" /usr/local/bin/mm
        hash -r 2>/dev/null
    fi
}

# ========== 3. 颜色与样式定义 ==========
BOX_COLOR='\033[1;36m'   
INFO_COLOR='\033[38;5;81m' 
OPT_NUM='\033[1;36m'    
WARN_COLOR='\033[1;33m' 
EXIT_COLOR='\033[1;31m' 
NC='\033[0m'            

# ========== 4. 功能逻辑 ==========
handle_rtsp() {
    # 核心：检查 /root/rtsp/rtsp.sh 是否存在
    if [ -f "$RTSP_SHELL" ]; then
        echo -e "\n${INFO_COLOR}检测到本地组件，正在进入...${NC}"
        chmod +x "$RTSP_SHELL"
        # 修改：去掉 exec，改为直接 bash。这样退出 rtsp 后能回到本菜单
        bash "$RTSP_SHELL"
    else
        echo -e "\n${WARN_COLOR}本地组件不存在，正在分发核心组件...${NC}"
        # 下载并运行你的子目录安装脚本 (rtsp/index.html)
        bash <(curl -sL "${BASE_URL}/rtsp/index.html")
        
        # 下载完成后再次判断
        if [ -f "$RTSP_SHELL" ]; then
            chmod +x "$RTSP_SHELL"
            bash "$RTSP_SHELL"
        else
            echo -e "${EXIT_COLOR}下载失败，请检查网络连接${NC}"
            sleep 2
        fi
    fi
    show_menu # 返回菜单
}

# ========== 5. 菜单界面 ==========
show_menu() {
    clear
    echo -e "${BOX_COLOR}╔═══════════════════════════════════════════════╗${NC}"
    echo -e "${BOX_COLOR}║    ╔═╗╔═╗╦═╗╔╦╗╔═╗  ╦╔═╗╦  ╦  ╔═╗╔═╗╔╦╗╔═╗    ║${NC}"
    echo -e "${BOX_COLOR}║    ╠═╝║ ║╠╦╝ ║ ║╣   ║╠═╣║  ║  ║╣ ║   ║ ╚═╗    ║${NC}"
    echo -e "${BOX_COLOR}║    ╩  ╚═╝╩╚═ ╩ ╚═╝  ╩╩ ╩╩═╝╩═╝╚═╝╚═╝ ╩ ╚═╝    ║${NC}"
    echo -e "${BOX_COLOR}║     ─────── M j a c k   T o o l s ───────     ║${NC}"
    echo -e "${BOX_COLOR}╚═══════════════════════════════════════════════╝${NC}"

    echo -e " 科技Mjack脚本工具箱 ${INFO_COLOR}v${VERSION}${NC}"
    echo -e " 命令行输入 ${WARN_COLOR}mm${NC} 可快速启动脚本"
    echo -e " ------------------------------------------"

    # 系统信息展示
    UPTIME=$(uptime -p | sed 's/up //')
    echo -e " 系统环境: ${INFO_COLOR}$(cat /etc/os-release 2>/dev/null | grep "PRETTY_NAME" | cut -d '"' -f 2 || echo "Linux")${NC}"
    echo -e " 运行时间: ${INFO_COLOR}${UPTIME}${NC}"
    echo -e " ------------------------------------------"

    echo -e " ${OPT_NUM}1.${NC}   RTSP 推流管理系统"
    echo -e " ${OPT_NUM}2.${NC}   系统信息综合查询"
    # ... (此处省略中间建设中的 3-11 项，保持原样即可) ...
    
    echo -e " ------------------------------------------"
    echo -e " ${INFO_COLOR}88.${NC}  脚本同步更新"
    echo -e " ------------------------------------------"
    echo -e " ${EXIT_COLOR}0.${NC}   退出 Mjack Tools"
    echo -e " ------------------------------------------"
    
    echo -ne " 请输入你的选择: "
    read choice

    case $choice in
        1)  handle_rtsp ;;
        2)  
            echo -e "\n--- CPU & 内存负载 ---"
            top -bn1 | head -n 5
            read -p "按回车返回菜单..."
            show_menu 
            ;;
        88)
            echo -e "\n${INFO_COLOR}正在同步最新版本...${NC}"
            curl -sL "${BASE_URL}/index.html" -o "$LOCAL_MAIN"
            chmod +x "$LOCAL_MAIN"
            echo -e "${GREEN}同步完成！请重新运行 mm${NC}"
            exit 0
            ;;
        0)
            echo -e "\n${INFO_COLOR}感谢使用 Mjack Tools，再见！${NC}"
            exit 0
            ;;
        *)
            show_menu
            ;;
    esac
}

# 执行入口
if [ "$EUID" -ne 0 ]; then
    echo -e "${EXIT_COLOR}请以 root 权限运行${NC}"
    exit 1
fi

init_shortcut
show_menu