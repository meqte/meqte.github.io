#!/bin/bash

# ====================================================
# Mjack Tools - RTSP 组件分发脚本
# 目标路径: /root/rtsp/
# ====================================================

# 1. 配置下载源
# 确保此链接指向你存放 rtsp.sh, mediamtx 等文件的 GitHub 目录
GITHUB_RAW="https://raw.githubusercontent.com/meqte/meqte.github.io/main/sh/rtsp"
TARGET_DIR="/root/rtsp"

# 颜色定义
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m'

echo -e "${GREEN}开始初始化 RTSP 环境...${NC}"

# 2. 创建目录结构
# -p 参数确保目录存在时不报错，且能递归创建
if [ ! -d "$TARGET_DIR" ]; then
    echo -e "${YELLOW}正在创建目录: $TARGET_DIR${NC}"
    mkdir -p "$TARGET_DIR/4K" "$TARGET_DIR/logs"
fi

# 3. 定义需要下载的文件清单
# 请确保这些文件在你的 GitHub 仓库中真实存在
FILES=("rtsp.sh" "mediamtx" "mediamtx.yml")

echo -e "${GREEN}正在从 GitHub 下载组件资源...${NC}"

for FILE in "${FILES[@]}"; do
    DOWNLOAD_URL="${GITHUB_RAW}/${FILE}"
    echo -e "  --> 正在获取: ${YELLOW}$FILE${NC}"
    
    # 使用 wget 下载
    # -q: 静默模式  -L: 跟踪重定向  -O: 指定保存路径
    wget -q -L -O "$TARGET_DIR/$FILE" "$DOWNLOAD_URL"
    
    # 检查上一个命令的退出状态码
    if [ $? -ne 0 ]; then
        echo -e "${RED}[错误] 下载失败: $FILE${NC}"
        echo -e "${RED}请检查链接是否有效: $DOWNLOAD_URL${NC}"
        exit 1
    fi
done

# 4. 权限设置
echo -e "${GREEN}正在配置执行权限...${NC}"
chmod +x "$TARGET_DIR/rtsp.sh"
chmod +x "$TARGET_DIR/mediamtx"

# 5. 创建功能快捷键 (非主脚本快捷键)
# 修改：这里改为 'rtsp'，不再使用 'm'，避免与主菜单 mm.sh 冲突
ln -sf "$TARGET_DIR/rtsp.sh" /usr/local/bin/rtsp

echo -e "${GREEN}==========================================${NC}"
echo -e "${GREEN}  RTSP 组件分发完成！${NC}"
echo -e "${GREEN}  脚本保存路径: $TARGET_DIR/rtsp.sh${NC}"
echo -e "${GREEN}  快捷启动命令: ${YELLOW}rtsp${NC}"
echo -e "${GREEN}==========================================${NC}"